version: "3.1"

rules:
# =============================================================================
# SYSTEM & INITIALIZATION RULES
# =============================================================================

- rule: Fallback Rule
  steps:
    - intent: nlu_fallback
    - action: utter_default_fallback

- rule: Initialize user on chat start
  steps:
    - intent: initialize
    - action: action_initialize_user

- rule: Respond if user is authenticated
  condition:
    - slot_was_set:
        - authenticated: true
  steps:
    - action: utter_authenticated

# =============================================================================
# BASIC INTERACTION RULES
# =============================================================================

- rule: Respond to greeting
  steps:
  - intent: greet
  - action: utter_greet_back
  - action: utter_offer_help

- rule: Respond to chitchat
  steps:
  - intent: chitchat
  - action: utter_chitchat
  - action: utter_followup_offer_help

- rule: Respond to bot options request
  steps:
  - intent: ask_bot_supplied_services
  - action: utter_list_bot_options
  - action: utter_followup_offer_help

- rule: Apologetic bot response
  steps:
  - intent: user_express_disbelief_in_bot
  - action: utter_bot_apology

- rule: Question ability to help
  steps:
  - intent: user_question_ability_to_help
  - action: utter_bot_reassure_user
  - action: utter_list_bot_options
  - action: utter_followup_offer_help

# =============================================================================
# COURSE SCHEDULE & INFORMATION RULES
# =============================================================================

- rule: Handle specific course schedule requests
  steps:
    - intent: ask_next_schedule_of_course_by_course_name
    - action: action_track_conversation_context
    - action: action_get_date_of_next_course
    - action: action_suggest_course_related_info

# =============================================================================
# COURSE CLASSROOM INFORMATION RULES
# =============================================================================

- rule: Fetch classroom of course and offer follow up help
  steps:
  - intent: ask_course_classroom_by_course_name
  - action: action_fetch_course_classroom_by_course_name
  - slot_was_set:
    - course_classroom_found: True
  - action: utter_fetch_classroom_of_course_by_course_name_success
  - action: utter_followup_offer_help

- rule: Fetch classroom of course, but user is not enrolled
  steps:
  - intent: ask_course_classroom_by_course_name
  - action: action_fetch_course_classroom_by_course_name
  - slot_was_set:
    - course_classroom_found: False
  - action: utter_fetch_classroom_of_course_by_course_name_fail
  - action: action_suggest_similar_courses

# =============================================================================
# COURSE TEACHER INFORMATION RULES
# =============================================================================

- rule: Fetch teacher of course, more than one teacher name is found
  steps:
  - intent: ask_course_teacher_by_course_name
  - action: action_fetch_course_teacher_by_course_name
  - slot_was_set:
    - course_teacher_name_found: True
  - slot_was_set:
    - course_teacher_name_found_multiple: True
  - action: utter_fetch_teachers_of_course_by_course_name
  - action: utter_followup_offer_help

- rule: Fetch teacher of course, one teacher name is found
  steps:
  - intent: ask_course_teacher_by_course_name
  - action: action_fetch_course_teacher_by_course_name
  - slot_was_set:
    - course_teacher_name_found: True
  - slot_was_set:
    - course_teacher_name_found_multiple: False
  - action: utter_fetch_teacher_of_course_by_course_name
  - action: utter_followup_offer_help

- rule: Fetch teacher of course, but course is not extracted
  steps:
  - intent: ask_course_teacher_by_course_name
  - action: action_fetch_course_teacher_by_course_name
  - slot_was_set:
    - course_teacher_name_found: False
  - slot_was_set:
    - course_teacher_name_found_multiple: False
  - slot_was_set:
    - course_name: null
  - action: utter_fetch_teachers_of_course_by_course_name_none

- rule: Get teacher of this course
  steps:
    - intent: ask_teacher_of_this_course
    - action: action_get_teacher_of_this_course
    - action: action_offer_contextual_help

# =============================================================================
# EDUCATIONAL SUPPORT RULES
# =============================================================================

- rule: Answer educational question from PDFs
  steps:
    - intent: ask_educational_question_from_pdf
    - action: action_answer_from_pdf
    - action: utter_followup_offer_help

- rule: User agrees to persist level of detail
  condition:
    - slot_was_set:
      - offered_to_persist_level_of_detail: true
  steps:
    - intent: affirm_persist_level_of_detail
    - action: action_update_level_of_detail_user_preference
    - action: utter_affirm_persist_level_of_detail

- rule: User denies persisting level of detail
  condition:
    - slot_was_set:
      - offered_to_persist_level_of_detail: true
  steps:
    - intent: deny_persist_level_of_detail
    - slot_was_set:
        - offered_to_persist_level_of_detail: true
    - action: utter_deny_persist_level_of_detail

# =============================================================================
# DEPARTMENT INFORMATION RULES (CONSOLIDATED)
# =============================================================================

- rule: Handle all department information requests
  steps:
    - or:
      - intent: get_department_secretariat_info
      - intent: get_department_secretariat_phone  
      - intent: get_department_secretariat_email
      - intent: get_department_secretariat_availability
      - intent: get_department_website_url
    - action: action_get_department_secretariat_info
    - action: action_offer_contextual_help

# =============================================================================
# MEETING SCHEDULING FORM RULES
# =============================================================================

- rule: Activate schedule meeting with teacher form
  steps:
    - intent: user_request_scheduled_meeting_with_teacher
    - action: scheduled_meeting_with_teacher_form
    - active_loop: scheduled_meeting_with_teacher_form

- rule: Submit schedule meeting with teacher form
  condition:
    - active_loop: scheduled_meeting_with_teacher_form
  steps:
  - action: scheduled_meeting_with_teacher_form
  - active_loop: null
  - slot_was_set:
    - requested_slot: null
  - action: action_schedule_meeting_with_teacher
  - action: action_schedule_meeting_with_teacher_reset

- rule: User cancels teacher meeting form request
  condition:
    - active_loop: scheduled_meeting_with_teacher_form
  steps:
  - intent: user_cancel_request
  - active_loop: null
  - slot_was_set:
    - requested_slot: null
  - action: action_schedule_meeting_with_teacher_reset
  - action: utter_confirm_cancel
  - action: utter_followup_offer_help

# =============================================================================
# ENHANCED ERROR HANDLING & RECOVERY RULES
# =============================================================================

- rule: Handle teacher not found with alternatives
  steps:
    - intent: ask_course_teacher_by_course_name
    - action: action_fetch_course_teacher_by_course_name
    - slot_was_set:
        - course_teacher_name_found: False
    - slot_was_set:
      - course_teacher_name_found_multiple: null
    - action: utter_fetch_teachers_of_course_by_course_name_none
    - action: action_offer_course_alternatives

- rule: Handle no context for teacher query
  condition:
    - slot_was_set:
        - last_course_name_provided_by_bot: null
  steps:
    - intent: ask_teacher_of_this_course
    - action: action_clarify_course_for_teacher_query

# =============================================================================
# SMART CONVERSATIONAL RULES
# =============================================================================

- rule: Handle vague schedule queries (triggers button selection)
  steps:
    - intent: ask_vague_schedule
    - action: action_smart_schedule_query
    - action: action_track_conversation_context

- rule: Handle today remaining schedule requests
  steps:
    - intent: ask_today_remaining_schedule
    - action: action_smart_schedule_query
    - action: action_track_conversation_context

- rule: Handle tomorrow schedule requests  
  steps:
    - intent: ask_tomorrow_schedule
    - action: action_smart_schedule_query
    - action: action_track_conversation_context

- rule: Handle tomorrow full schedule requests
  steps:
    - intent: ask_tomorrow_full_schedule
    - action: action_smart_schedule_query
    - action: action_track_conversation_context

- rule: Handle Monday schedule requests
  steps:
    - intent: ask_monday_schedule
    - action: action_smart_schedule_query
    - action: action_track_conversation_context

- rule: Handle today schedule requests
  steps:
    - intent: ask_today_schedule
    - action: action_smart_schedule_query
    - action: action_track_conversation_context

- rule: Handle weekly schedule requests
  steps:
    - intent: user_asks_schedule_rest_of_the_week
    - action: action_get_weekly_schedule
    - action: utter_followup_offer_help

- rule: Handle next available course requests
  steps:
    - intent: ask_next_available_course
    - action: action_smart_schedule_query

- rule: Provide break suggestions
  steps:
    - intent: ask_break_suggestions
    - action: action_provide_break_suggestions

- rule: Handle help requests
  steps:
    - intent: ask_help
    - action: utter_list_bot_options
    - action: utter_followup_offer_help

- rule: Handle library location queries
  steps:
    - intent: ask_library_location
    - action: utter_default_fallback

- rule: Handle food options queries
  steps:
    - intent: ask_food_options
    - action: utter_default_fallback

- rule: Handle course info queries
  steps:
    - intent: ask_course_info
    - action: action_fetch_course_classroom_by_course_name
    - slot_was_set:
      - course_classroom_found: True
    - action: utter_followup_offer_help

- rule: Handle course full info queries
  steps:
    - intent: ask_course_full_info
    - action: action_fetch_course_classroom_by_course_name
    - slot_was_set:
      - course_classroom_found: True
    - action: action_fetch_course_teacher_by_course_name
    - slot_was_set:
      - course_teacher_name_found: True
    - slot_was_set:
      - course_teacher_name_found_multiple: Null
    - action: utter_followup_offer_help